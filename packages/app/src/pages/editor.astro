---
import EditorView from "../editor/views/editor";
import AppShell from "../layouts/app-shell.astro";
import { redirectToLoginIfNotAuthenticated } from "../lib/auth/redirect-to-login-if-not-authenticated";

const redirectToLogin = await redirectToLoginIfNotAuthenticated(Astro);

if (redirectToLogin) return redirectToLogin;
---

<AppShell>
  <div class="min-h-full p-16">
    <div
      id="editor"
      class="container max-w-6xl mx-auto text-base-content"
    >
      <EditorView client:only="solid-js" />
    </div>
  </div>
</AppShell>

<script>
  import { pb, refreshAuthCookie, validateServerSession } from "../editor/lib/api-client";
  import editorStore from "../editor/lib/editor-store";
  import { SIGN_IN_URL } from "../global";

  await validateServerSession();

  editorStore.initialize(pb());

  pb().authStore.onChange((token: string) => {
    if (token) refreshAuthCookie(token);
    else location.href = SIGN_IN_URL;
  });
</script>
